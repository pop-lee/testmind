<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" width="100%" height="100%"
    creationComplete="creaHandle()" applicationComplete="appHandle()"
    mouseDown="mouseDownHandle(event)" 
    
    >
    <mx:Script>
        <![CDATA[
            import flash.sampler.getInvocationCount;
            import mx.core.UIComponent;
            import mx.managers.DragManager;
            import mx.events.DragEvent;
            import model.MindModel;
            import view.Node;
            
            public static var mainNode : Node = new Node();
            
            private var mainModel : MindModel = MindModel.getInstance();
            
            private function creaHandle() : void
            {
                mainModel.main = this;
                test() ;
            }
            
            private function test() : void
            {
                mainNode.x = this.width/3;
                mainNode.y = this.height/3;
//                mainNode.direction = "middle";
                mainNode.setFocusNode();
                addChild(mainNode);
                for each(var _xml : Object in xmllc) {
                    createNode(_xml,mainNode);
                }
//                var node2 : Node = new Node();
//                node2.parentNode = mainNode;
//                var node3 : Node = new Node();
//                node3.parentNode = mainNode;
//                var node4 : Node = new Node();
//                node4.parentNode = mainNode;
//                var node5 : Node = new Node();
//                node5.parentNode = node2;
                
//                addChild(node2);
//                addChild(node3);
//                addChild(node4);
//                addChild(node5);
            }
            
            private function createNode(obj : Object,_parentNode : Node) : void
            {
                if(obj.hasOwnProperty("node")) {
                    
                    for each(var _childNode : Object in obj.node) {
                        var _node : Node = new Node();
                        if(_childNode.hasOwnProperty("content"))
                            _node.nodeContent = _childNode.content;
                        if(_childNode.hasOwnProperty("direction")) 
                            _node.direction = _childNode.direction;
                        _node.parentNode = _parentNode;
                        addChild(_node);
                        createNode(_childNode,_node);
                    }
                }
            }
            
            private function appHandle() : void
            {
                this.stage.addEventListener(KeyboardEvent.KEY_UP,enterKeyHandle);
            }
            
            private function enterKeyHandle(event : KeyboardEvent) : void
            {
                var tempNode : Node ;
                if(event.keyCode == 13) {
                    if(mainModel.focusNode!=null&&!mainModel.focusNode.isEditable) {
                        tempNode = new Node();
                        addChild(tempNode);
                        if(event.ctrlKey||mainModel.focusNode.parentNode==null)
                            tempNode.parentNode = mainModel.focusNode;
                        else
                            tempNode.parentNode = mainModel.focusNode.parentNode;
                        tempNode.isEditable = true;
                        tempNode.setFocusNode();
                    }
                }
            }
            
            private function mouseDownHandle(event : MouseEvent) : void
            {
                mainModel.focusNode.setFocus();
            }
//            private function dragEnterHandle(event : DragEvent,format : String) : void
//            {
//                if(event.dragSource.hasFormat(format)) 
//                    DragManager.acceptDragDrop(event.target as UIComponent);
//            }
//            
//            private function dragDropHandle(event : DragEvent,format : String) : void
//            {
//                mainModel.dragNode = null;
//                stopDrag();
//            }
            
//            private function mouseMoveHandle(event : MouseEvent) : void
//            {
//                if(mainModel.dragNode != null) {
//                    mainModel.dragNode.x = event.stageX - mainModel.dragNode.mouseX;
//                    mainModel.dragNode.y = event.stageY - mainModel.dragNode.mouseY;
//                    mainModel.dragNode.refreshLine();
//                }
//            }
            
        ]]>
    </mx:Script>
    <mx:XML id="dp" source="/model/model001.xml" />
    <mx:XMLListCollection id="xmllc" source="{dp.Nodes}" />
    
    <!--
    <mx:Model id="dp" source="/model/model001.xml" />
    <mx:XMLList id="dp" xmlns="/model/model001.xml" />
    -->
    
    
</mx:Application>
